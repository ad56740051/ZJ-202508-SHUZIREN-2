# 数字人语音播放问题修复指南

## 问题描述
当运行数字人时，数字人文本聊天在后台可以看到内容，但是本地语音无法正常播放。

## 问题原因分析
通过日志分析发现，系统在使用在线EdgeTTS服务时遇到网络连接问题：
- 无法连接到 `speech.platform.bing.com:443`
- 出现 `getaddrinfo failed` 错误
- 网络连接超时或DNS解析失败

## 解决方案

### 1. 使用本地TTS启动脚本
**重要：请使用正确的启动脚本**

```bash
# 使用本地TTS启动（推荐）
2.webui_local_tts.bat

# 不要使用这个（会使用在线TTS）
2.webui.bat
```

### 2. 确保使用本地TTS配置
检查启动参数中是否包含 `--tts local_edgetts`：

```bash
.\python\python.exe app.py --avatar_id avatar11 --customvideo_config custom_video.json --tts local_edgetts
```

### 3. 本地TTS功能特性
- ✅ 支持离线运行，无需网络连接
- ✅ 自动备选TTS引擎（pyttsx3）
- ✅ 当EdgeTTS失败时自动切换到本地TTS
- ✅ 支持多种中文语音

## 测试验证

### 1. 运行TTS功能测试
```bash
python test_local_tts.py
```

### 2. 运行离线TTS测试
```bash
python test_offline_tts.py
```

### 3. 运行音频播放测试
```bash
python test_audio_playback.py
```

## 故障排除

### 问题1：仍然使用在线TTS
**解决方案：**
1. 确保使用 `2.webui_local_tts.bat` 启动
2. 检查启动参数是否包含 `--tts local_edgetts`
3. 重启应用程序

### 问题2：备选TTS不可用
**解决方案：**
```bash
pip install pyttsx3
```

### 问题3：音频无法播放
**解决方案：**
1. 检查音频设备是否正常
2. 确保音量设置正确
3. 运行音频播放测试验证

## 技术实现细节

### 本地TTS架构
```
LocalEdgeTTS
├── EdgeTTS (在线，优先使用)
└── pyttsx3 (本地备选)
```

### 自动故障转移机制
1. 首先尝试使用EdgeTTS（在线）
2. 如果网络连接失败，自动切换到pyttsx3（本地）
3. 确保在任何情况下都能生成语音

### 支持的语音
- zh-CN-XiaoxiaoNeural (晓晓)
- zh-CN-YunxiNeural (云希)
- zh-CN-YunyangNeural (云扬)
- zh-CN-XiaoyiNeural (晓伊)
- 更多中文语音...

## 配置文件
`local_tts_config.json` 包含TTS配置：
```json
{
    "tts_settings": {
        "default_voice": "zh-CN-XiaoxiaoNeural",
        "available_voices": {...},
        "audio_settings": {
            "sample_rate": 16000,
            "channels": 1,
            "format": "wav"
        }
    }
}
```

## 日志监控
查看 `wav2lip_realtime.log` 文件中的TTS相关日志：
- 成功：`EdgeTTS文本转语音完成`
- 失败：`EdgeTTS转换失败，尝试使用备选TTS`
- 备选：`使用备选TTS引擎进行转换`

## 性能优化建议
1. 使用本地TTS可减少网络延迟
2. 备选TTS响应更快，但音质稍差
3. 可根据网络情况选择合适的TTS引擎

## 联系支持
如果问题仍然存在，请：
1. 运行所有测试脚本
2. 收集错误日志
3. 提供测试结果截图


